#ifndef __CUML__
#define __CUML__

#include "cudf"

RUN apt-get update && \\
    apt-get install -y --no-install-recommends \\
        libopenblas-dev \\
        zlib1g-dev && \\
    rm -rf /var/lib/apt/lists && \\
    mkdir /var/lib/apt/lists

RUN conda install -c anaconda -c pytorch \\
        cmake=3.13 \\
        Cython \\
        faiss-gpu \\
        pytest \\
        scikit-learn && \\
    conda clean -ya

RUN git clone --recursive "https://github.com/rapidsai/cuml" /opt/cuml

RUN /bin/bash -c "source activate cudf && \
        cd /opt/cuml/cuML && \
        mkdir build && \
        cd build && \
        cmake .. && \
        make -j && \
        make install"

///HACK!!! until the issue with cuml python build gets fixed!!
// RUN /bin/bash -c "source activate cudf && \
//         cd /opt/cuml/python && \
//         python setup.py build_ext --inplace && \
//         python setup.py install"

COPY contexts/dev-cuml /opt/dev-cuml

RUN chmod a+x /opt/dev-cuml/cuml

ENV PATH=/opt/dev-cuml:$PATH

#endif // __CUML__
